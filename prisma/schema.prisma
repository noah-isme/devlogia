generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
}

enum RoleName {
  SUPERADMIN
  TENANTADMIN
  ADMIN
  EDITOR
  WRITER
  VIEWER
}

enum PluginVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum PluginInstallStatus {
  ACTIVE
  DISABLED
}

enum ExtensionSurface {
  EDITOR
  ANALYTICS
  DASHBOARD
  WEBHOOK
  SDK
}

enum ExtensionRuntime {
  EDGE
  SERVER
  CLIENT
}

model User {
  id              String           @id @default(cuid()) @db.VarChar(191)
  email           String           @unique @db.VarChar(191)
  passwordHash    String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  posts           Post[]
  auditLogs       AuditLog[]
  roles           UserRole[]
  aiUsage         AIUsage[]
  aiAuditLogs     AIAuditLog[]
  profile         UserProfile?
  ownedTenants    Tenant[]         @relation("TenantOwner")
  pluginsCreated  Plugin[]         @relation("PluginCreator")
  pluginInstalls  PluginInstall[]  @relation("PluginInstallInstaller")
  extensionUsages ExtensionUsage[] @relation("ExtensionUsageActor")
}

model Role {
  id          String     @id @default(cuid()) @db.VarChar(191)
  name        RoleName   @unique
  description String?
  createdAt   DateTime   @default(now())
  users       UserRole[]
}

model UserRole {
  id         String   @id @default(cuid()) @db.VarChar(191)
  userId     String   @db.VarChar(191)
  roleId     String   @db.VarChar(191)
  assignedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  role       Role     @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
  @@index([roleId])
}

model Post {
  id               String            @id @default(cuid()) @db.VarChar(191)
  slug             String            @unique @db.VarChar(191)
  title            String            @db.VarChar(191)
  summary          String?           @db.VarChar(512)
  contentMdx       String            @db.LongText
  coverUrl         String?           @db.VarChar(512)
  status           PostStatus        @default(DRAFT)
  publishedAt      DateTime?
  authorId         String            @db.VarChar(191)
  author           User              @relation(fields: [authorId], references: [id])
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  tags             PostTag[]
  embedding        Embedding?
  recommendations  Recommendation[]  @relation("RecommendationSource")
  recommendedBy    Recommendation[]  @relation("RecommendationTarget")
  topics           PostTopic[]
  headlineVariants HeadlineVariant[]
  aiUsage          AIUsage[]
  aiAuditLogs      AIAuditLog[]
  contentVector    ContentVector?
  federationIndex  FederationIndex?

  @@index([status, publishedAt])
}

model Tag {
  id    String    @id @default(cuid()) @db.VarChar(191)
  name  String    @unique @db.VarChar(191)
  slug  String    @unique @db.VarChar(191)
  posts PostTag[]
}

model PostTag {
  postId String @db.VarChar(191)
  tagId  String @db.VarChar(191)
  post   Post   @relation(fields: [postId], references: [id])
  tag    Tag    @relation(fields: [tagId], references: [id])

  @@id([postId, tagId])
}

model Page {
  id         String   @id @default(cuid()) @db.VarChar(191)
  slug       String   @unique @db.VarChar(191)
  title      String   @db.VarChar(191)
  contentMdx String   @db.LongText
  published  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Media {
  id        String   @id @default(cuid()) @db.VarChar(191)
  path      String   @db.VarChar(512)
  mimeType  String   @db.VarChar(191)
  sizeBytes Int
  checksum  String   @db.Char(64)
  publicUrl String   @db.VarChar(2048)
  alt       String?  @db.VarChar(256)
  ownerId   String?  @db.VarChar(191)
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid()) @db.VarChar(191)
  userId    String?  @db.VarChar(191)
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  targetId  String?
  meta      Json?
  createdAt DateTime @default(now())
}

model HeadlineVariant {
  id        String   @id @default(cuid()) @db.VarChar(191)
  postId    String   @db.VarChar(191)
  title     String   @db.VarChar(191)
  abKey     String   @db.VarChar(64)
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id])

  @@unique([postId, abKey])
  @@index([postId])
}

model AIUsage {
  id        String   @id @default(cuid()) @db.VarChar(191)
  userId    String   @db.VarChar(191)
  postId    String?  @db.VarChar(191)
  task      String   @db.VarChar(64)
  model     String   @db.VarChar(191)
  provider  String   @db.VarChar(64)
  tokensIn  Int      @default(0)
  tokensOut Int      @default(0)
  usd       Decimal  @db.Decimal(10, 4)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  post      Post?    @relation(fields: [postId], references: [id])

  @@index([userId, createdAt])
  @@index([postId, createdAt])
}

model AIAuditLog {
  id            String   @id @default(cuid()) @db.VarChar(191)
  userId        String?  @db.VarChar(191)
  postId        String?  @db.VarChar(191)
  task          String   @db.VarChar(64)
  promptHash    String   @db.Char(64)
  promptExcerpt String   @db.VarChar(200)
  model         String   @db.VarChar(191)
  provider      String   @db.VarChar(64)
  tokens        Int      @default(0)
  moderated     Boolean  @default(false)
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id])
  post          Post?    @relation(fields: [postId], references: [id])

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([postId, createdAt])
}

model Embedding {
  id        String                   @id @default(cuid()) @db.VarChar(191)
  postId    String                   @unique @db.VarChar(191)
  model     String                   @db.VarChar(191)
  provider  String                   @db.VarChar(191)
  dimension Int
  vector    Json
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
  post      Post                     @relation(fields: [postId], references: [id])
  snapshots RecommendationSnapshot[]
}

model Recommendation {
  id           String   @id @default(cuid()) @db.VarChar(191)
  sourcePostId String   @db.VarChar(191)
  targetPostId String   @db.VarChar(191)
  score        Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  source       Post     @relation("RecommendationSource", fields: [sourcePostId], references: [id])
  target       Post     @relation("RecommendationTarget", fields: [targetPostId], references: [id])

  @@unique([sourcePostId, targetPostId])
  @@index([sourcePostId])
  @@index([targetPostId])
}

model RecommendationSnapshot {
  id          String    @id @default(cuid()) @db.VarChar(191)
  embeddingId String    @db.VarChar(191)
  metadata    Json
  createdAt   DateTime  @default(now())
  embedding   Embedding @relation(fields: [embeddingId], references: [id])

  @@index([embeddingId])
}

model UserProfile {
  id                    String                @id @default(cuid()) @db.VarChar(191)
  userId                String                @unique @db.VarChar(191)
  topics                Json                  @default("{}")
  preferences           Json                  @default("{}")
  featureVector         Json?
  avgReadTimeSeconds    Int                   @default(0)
  sessionCount          Int                   @default(0)
  viewCount             Int                   @default(0)
  tonePreference        String?               @db.VarChar(64)
  segment               String?               @db.VarChar(64)
  personalizationOptOut Boolean               @default(false)
  analyticsOptOut       Boolean               @default(false)
  lastActiveAt          DateTime?
  lastInsightRefresh    DateTime?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  user                  User                  @relation(fields: [userId], references: [id])
  affinities            UserContentAffinity[]
}

model ContentVector {
  id              String                @id @default(cuid()) @db.VarChar(191)
  postId          String                @unique @db.VarChar(191)
  embedding       Json
  topicTags       Json                  @default("[]")
  engagementScore Float                 @default(0)
  freshnessScore  Float                 @default(0)
  highlights      Json?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  post            Post                  @relation(fields: [postId], references: [id])
  affinities      UserContentAffinity[]
}

model UserContentAffinity {
  id              String        @id @default(cuid()) @db.VarChar(191)
  userProfileId   String        @db.VarChar(191)
  contentVectorId String        @db.VarChar(191)
  affinity        Float         @default(0)
  reason          Json?
  lastEngagedAt   DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  userProfile     UserProfile   @relation(fields: [userProfileId], references: [id])
  contentVector   ContentVector @relation(fields: [contentVectorId], references: [id])

  @@unique([userProfileId, contentVectorId])
  @@index([contentVectorId])
  @@map("user_content_affinity")
}

model TopicCluster {
  id        String      @id @default(cuid()) @db.VarChar(191)
  label     String      @db.VarChar(191)
  keywords  Json
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  posts     PostTopic[]
}

model PostTopic {
  id        String       @id @default(cuid()) @db.VarChar(191)
  postId    String       @db.VarChar(191)
  topicId   String       @db.VarChar(191)
  score     Float        @default(0)
  createdAt DateTime     @default(now())
  post      Post         @relation(fields: [postId], references: [id])
  topic     TopicCluster @relation(fields: [topicId], references: [id])

  @@unique([postId, topicId])
  @@index([topicId])
}

model Tenant {
  id                String            @id @default(cuid()) @db.VarChar(191)
  name              String            @db.VarChar(191)
  slug              String            @unique @db.VarChar(191)
  plan              String            @default("free") @db.VarChar(32)
  ownerId           String?           @db.VarChar(191)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  owner             User?             @relation("TenantOwner", fields: [ownerId], references: [id])
  settings          TenantSettings?
  federationEntries FederationIndex[]
  analytics         TenantAnalytics?
  publishedPlugins  Plugin[]          @relation("PluginPublisher")
  pluginInstalls    PluginInstall[]
  extensionUsage    ExtensionUsage[]
  extensions        Extension[]

  @@index([ownerId])
}

model TenantSettings {
  id        String   @id @default(cuid()) @db.VarChar(191)
  tenantId  String   @unique @db.VarChar(191)
  domain    String?  @db.VarChar(191)
  limits    Json     @default("{}")
  planId    String?  @db.VarChar(64)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model FederationIndex {
  id        String   @id @default(cuid()) @db.VarChar(191)
  postId    String   @unique @db.VarChar(191)
  tenantId  String   @db.VarChar(191)
  title     String?  @db.VarChar(191)
  tags      Json     @default("[]")
  embedding Json?
  score     Float?   @default(0)
  updatedAt DateTime @updatedAt
  post      Post     @relation(fields: [postId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, updatedAt])
}

model TenantAnalytics {
  id              String   @id @default(cuid()) @db.VarChar(191)
  tenantId        String   @unique @db.VarChar(191)
  visits          Int      @default(0)
  aiUsage         Decimal  @default(0) @db.Decimal(12, 4)
  revenue         Decimal  @default(0) @db.Decimal(12, 2)
  federationShare Float    @default(0)
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([updatedAt])
}

model Plugin {
  id                String           @id @default(cuid()) @db.VarChar(191)
  slug              String           @unique @db.VarChar(191)
  name              String           @db.VarChar(191)
  summary           String?          @db.VarChar(512)
  description       String?          @db.Text
  version           String           @default("0.1.0") @db.VarChar(32)
  visibility        PluginVisibility @default(PRIVATE)
  repositoryUrl     String?          @db.VarChar(512)
  websiteUrl        String?          @db.VarChar(512)
  metadata          Json?            @default("{}")
  publisherTenantId String?          @db.VarChar(191)
  createdById       String?          @db.VarChar(191)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  publisherTenant   Tenant?          @relation("PluginPublisher", fields: [publisherTenantId], references: [id])
  creator           User?            @relation("PluginCreator", fields: [createdById], references: [id])
  extensions        Extension[]
  installs          PluginInstall[]

  @@index([publisherTenantId])
}

model PluginInstall {
  id            String              @id @default(cuid()) @db.VarChar(191)
  pluginId      String              @db.VarChar(191)
  tenantId      String              @db.VarChar(191)
  installedById String?             @db.VarChar(191)
  status        PluginInstallStatus @default(ACTIVE)
  settings      Json                @default("{}")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  plugin        Plugin              @relation(fields: [pluginId], references: [id])
  tenant        Tenant              @relation(fields: [tenantId], references: [id])
  installedBy   User?               @relation("PluginInstallInstaller", fields: [installedById], references: [id])

  @@unique([pluginId, tenantId])
  @@index([tenantId])
}

model Extension {
  id             String           @id @default(cuid()) @db.VarChar(191)
  pluginId       String           @db.VarChar(191)
  key            String           @db.VarChar(64)
  name           String           @db.VarChar(191)
  description    String?          @db.VarChar(512)
  surface        ExtensionSurface @default(EDITOR)
  runtime        ExtensionRuntime @default(EDGE)
  entrypoint     String           @db.VarChar(512)
  configSchema   Json?            @default("{}")
  sandboxConfig  Json?            @default("{}")
  metadata       Json?            @default("{}")
  targetTenantId String?          @db.VarChar(191)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  plugin         Plugin           @relation(fields: [pluginId], references: [id])
  targetTenant   Tenant?          @relation(fields: [targetTenantId], references: [id])
  usages         ExtensionUsage[]

  @@unique([pluginId, key])
  @@index([targetTenantId])
}

model ExtensionUsage {
  id             String    @id @default(cuid()) @db.VarChar(191)
  extensionId    String    @db.VarChar(191)
  tenantId       String    @db.VarChar(191)
  triggeredById  String?   @db.VarChar(191)
  context        Json?     @default("{}")
  durationMs     Int?
  tokensConsumed Int?      @default(0)
  costUsd        Decimal?  @db.Decimal(10, 4)
  occurredAt     DateTime  @default(now())
  extension      Extension @relation(fields: [extensionId], references: [id])
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  triggeredBy    User?     @relation("ExtensionUsageActor", fields: [triggeredById], references: [id])

  @@index([tenantId, occurredAt])
}
