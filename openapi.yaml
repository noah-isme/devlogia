openapi: 3.1.0
info:
  title: Devlogia Public API
  version: 1.0.0
  description: OpenAPI definition covering the public content and analytics endpoints exposed by Devlogia. Authentication
    is handled via NextAuth session cookies.
  contact:
    name: Devlogia Engineering
    url: https://devlogia.test
    email: engineering@devlogia.test
servers:
  - url: https://devlogia.test
    description: Production
  - url: http://localhost:3000
    description: Local development
security:
  - CookieAuth: []
components:
  securitySchemes:
    CookieAuth:
      type: apiKey
      in: cookie
      name: next-auth.session-token
      description: Session token issued by NextAuth. In browsers it is managed automatically after sign-in.
  schemas:
    SessionUser:
      type: object
      properties:
        name:
          type:
            - string
            - "null"
          example: Amalia
        email:
          type:
            - string
            - "null"
          format: email
          example: editor@devlogia.test
        image:
          type:
            - string
            - "null"
          format: uri
        role:
          type: string
          example: admin
      required:
        - name
        - email
      description: Authenticated user metadata.
    Session:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/SessionUser"
        expires:
          type: string
          format: date-time
          example: 2025-10-28T15:09:39.597Z
      required:
        - expires
      title: NextAuth Session
    Post:
      type: object
      properties:
        id:
          type: string
          example: post_123
        title:
          type: string
          example: Introducing Devlogia
        slug:
          type: string
          example: introducing-devlogia
        summary:
          type:
            - string
            - "null"
          example: Learn how Devlogia keeps your content workflow nimble.
        publishedAt:
          type:
            - string
            - "null"
          format: date-time
        updatedAt:
          type: string
          format: date-time
        url:
          type: string
          format: uri
      required:
        - id
        - title
        - slug
        - summary
        - publishedAt
        - updatedAt
        - url
      title: PublicPost
    Page:
      type: object
      properties:
        id:
          type: string
          example: page_123
        title:
          type: string
        slug:
          type: string
          example: about
        published:
          type: boolean
        updatedAt:
          type: string
          format: date-time
        url:
          type: string
          format: uri
      required:
        - id
        - title
        - slug
        - published
        - updatedAt
        - url
      title: PublicPage
    TrafficPoint:
      type: object
      properties:
        month:
          type: string
          example: 2024-06
        views:
          type: integer
          minimum: 0
          example: 1200
      required:
        - month
        - views
      description: Monthly view summary.
    AnalyticsResponse:
      type: object
      properties:
        posts:
          type: object
          properties:
            drafts:
              type: integer
              minimum: 0
            published:
              type: integer
              minimum: 0
            scheduled:
              type: integer
              minimum: 0
            views:
              type: integer
              minimum: 0
          required:
            - drafts
            - published
            - scheduled
            - views
        pages:
          type: object
          properties:
            total:
              type: integer
              minimum: 0
            published:
              type: integer
              minimum: 0
          required:
            - total
            - published
        users:
          type: object
          properties:
            total:
              type: integer
              minimum: 0
            active:
              type: integer
              minimum: 0
            inactive:
              type: integer
              minimum: 0
          required:
            - total
            - active
            - inactive
        tags:
          type: object
          properties:
            total:
              type: integer
              minimum: 0
            top:
              type: array
              items:
                type: object
                properties:
                  tag:
                    type: string
                  count:
                    type: integer
                    minimum: 0
                required:
                  - tag
                  - count
              description: Top tags with usage frequency.
          required:
            - total
            - top
        traffic:
          type: object
          properties:
            timeframe:
              type: string
              example: 6 months
            points:
              type: array
              items:
                $ref: "#/components/schemas/TrafficPoint"
          required:
            - timeframe
            - points
        generatedAt:
          type: string
          format: date-time
      required:
        - posts
        - pages
        - users
        - tags
        - traffic
        - generatedAt
    UploadFile:
      type: object
      properties:
        id:
          type: string
          example: media_123
        url:
          type: string
          format: uri
          example: https://cdn.devlogia.test/uploads/2024-04-01/header.png
        path:
          type: string
          example: uploads/2024-04-01/header.png
        mimeType:
          type: string
          example: image/png
        sizeBytes:
          type: integer
          example: 24576
        checksum:
          type: string
          minLength: 64
          maxLength: 64
          example: 0f343b0931126a20f133d67c2b018a3b
        alt:
          type: string
          example: Team photo
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - url
        - path
        - mimeType
        - sizeBytes
        - checksum
        - alt
        - createdAt
    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
        provider:
          type: string
          enum:
            - supabase
            - stub
        files:
          type: array
          items:
            $ref: "#/components/schemas/UploadFile"
      required:
        - success
        - provider
        - files
    AIExtension:
      type: object
      properties:
        id:
          type: string
        tenantId:
          type: string
        name:
          type: string
        provider:
          type: string
        model:
          type: string
        capability:
          type: string
        tokenCost:
          type: integer
        description:
          type:
            - string
            - "null"
        metadata:
          type:
            - object
            - "null"
        active:
          type: boolean
        monthlyTokens:
          type: integer
        monthlyCostCents:
          type: integer
        totalInvocations:
          type: integer
      required:
        - id
        - tenantId
        - name
        - provider
        - model
        - capability
        - tokenCost
        - active
        - monthlyTokens
        - monthlyCostCents
        - totalInvocations
    AIQuotaWarning:
      type: object
      properties:
        level:
          type: string
          enum:
            - warning
            - critical
        threshold:
          type: number
        utilization:
          type: number
        message:
          type: string
      required:
        - level
        - threshold
        - utilization
        - message
    AIQuotaStatus:
      type: object
      properties:
        limit:
          type:
            - integer
            - "null"
        used:
          type: integer
        remaining:
          type:
            - integer
            - "null"
        utilization:
          type: number
        warnings:
          type: array
          items:
            $ref: "#/components/schemas/AIQuotaWarning"
      required:
        - used
        - utilization
        - warnings
    AIUsageResponse:
      type: object
      properties:
        logId:
          type:
            - string
            - "null"
        quota:
          $ref: "#/components/schemas/AIQuotaStatus"
        warnings:
          type: array
          items:
            $ref: "#/components/schemas/AIQuotaWarning"
      required:
        - quota
        - warnings
    WorkspaceMember:
      type: object
      properties:
        id:
          type: string
        role:
          type: string
        joinedAt:
          type: string
          format: date-time
        user:
          type: object
          properties:
            id:
              type: string
            email:
              type: string
              format: email
          required:
            - id
            - email
      required:
        - id
        - role
        - joinedAt
        - user
    PresenceState:
      type: object
      properties:
        userId:
          type: string
        status:
          type: string
        lastSeenAt:
          type:
            - string
            - "null"
          format: date-time
      required:
        - userId
        - status
    WorkspaceSession:
      type: object
      properties:
        id:
          type: string
        startedAt:
          type: string
          format: date-time
        active:
          type: boolean
        presence:
          type: array
          items:
            $ref: "#/components/schemas/PresenceState"
      required:
        - id
        - startedAt
        - active
        - presence
    Workspace:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        slug:
          type: string
        createdAt:
          type: string
          format: date-time
        members:
          type: array
          items:
            $ref: "#/components/schemas/WorkspaceMember"
        sessions:
          type: array
          items:
            $ref: "#/components/schemas/WorkspaceSession"
      required:
        - id
        - name
        - slug
        - createdAt
        - members
        - sessions
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: Unauthorized
      required:
        - error
  parameters: {}
paths:
  /api/auth/session:
    get:
      tags:
        - Auth
      summary: Read the active session
      responses:
        "200":
          description: Current NextAuth session for the authenticated user.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
        "401":
          description: No active session.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/ai/extensions:
    get:
      tags:
        - AI
      summary: List AI extensions for a tenant
      parameters:
        - name: tenantId
          in: query
          required: true
          schema:
            type: string
        - name: includeInactive
          in: query
          required: false
          schema:
            type: boolean
      responses:
        "200":
          description: Active AI extensions scoped to the tenant.
          content:
            application/json:
              schema:
                type: object
                properties:
                  extensions:
                    type: array
                    items:
                      $ref: "#/components/schemas/AIExtension"
                required:
                  - extensions
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags:
        - AI
      summary: Register a new AI extension
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tenantId:
                  type: string
                name:
                  type: string
                provider:
                  type: string
                model:
                  type: string
                capability:
                  type: string
                tokenCost:
                  type: integer
                description:
                  type:
                    - string
                    - "null"
                metadata:
                  type:
                    - object
                    - "null"
              required:
                - tenantId
                - name
                - provider
                - model
                - capability
      responses:
        "201":
          description: Extension registered successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  extension:
                    $ref: "#/components/schemas/AIExtension"
                required:
                  - extension
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/ai/usage:
    post:
      tags:
        - AI
      summary: Record AI usage for billing and quota enforcement
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tenantId:
                  type: string
                userId:
                  type: string
                extensionId:
                  type: string
                tokensUsed:
                  type: integer
                costCents:
                  type: integer
                promptSummary:
                  type:
                    - string
                    - "null"
                moderationStatus:
                  type:
                    - string
                    - "null"
              required:
                - tenantId
                - userId
                - extensionId
                - tokensUsed
      responses:
        "200":
          description: Usage recorded and quota evaluated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AIUsageResponse"
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/workspaces:
    get:
      tags:
        - Collaboration
      summary: List collaboration workspaces for a tenant
      parameters:
        - name: tenantId
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Workspaces with active sessions and members.
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspaces:
                    type: array
                    items:
                      $ref: "#/components/schemas/Workspace"
                required:
                  - workspaces
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags:
        - Collaboration
      summary: Create a new workspace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tenantId:
                  type: string
                name:
                  type: string
                slug:
                  type:
                    - string
                    - "null"
                createdBy:
                  type: string
              required:
                - tenantId
                - name
                - createdBy
      responses:
        "201":
          description: Workspace created successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspace:
                    $ref: "#/components/schemas/Workspace"
                required:
                  - workspace
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/posts:
    get:
      tags:
        - Content
      summary: List published posts
      description: "Responses include `Cache-Control: public, s-maxage=60, stale-while-revalidate=300` to keep content fresh
        while allowing CDN reuse."
      responses:
        "200":
          description: Published posts ordered by publish date.
          content:
            application/json:
              schema:
                type: object
                properties:
                  posts:
                    type: array
                    items:
                      $ref: "#/components/schemas/Post"
                required:
                  - posts
  /api/pages:
    get:
      tags:
        - Content
      summary: List site pages
      description: "Responses include `Cache-Control: public, s-maxage=60, stale-while-revalidate=300` to keep content fresh
        while allowing CDN reuse."
      responses:
        "200":
          description: All CMS pages with visibility flags.
          content:
            application/json:
              schema:
                type: object
                properties:
                  pages:
                    type: array
                    items:
                      $ref: "#/components/schemas/Page"
                required:
                  - pages
  /api/rss:
    get:
      tags:
        - Content
      summary: RSS feed
      responses:
        "200":
          description: RSS 2.0 XML feed.
          content:
            application/rss+xml:
              schema:
                type: string
  /api/sitemap:
    get:
      tags:
        - Content
      summary: XML sitemap
      responses:
        "200":
          description: Sitemap XML for search crawlers.
          content:
            application/xml:
              schema:
                type: string
  /api/analytics:
    get:
      tags:
        - Analytics
      summary: Content analytics overview
      security:
        - CookieAuth: []
      responses:
        "200":
          description: Aggregated metrics for authenticated admins.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnalyticsResponse"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/uploadthing:
    post:
      tags:
        - Uploads
      summary: Upload media to the configured storage provider
      security:
        - CookieAuth: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: File contents
              required:
                - file
      responses:
        "200":
          description: Upload succeeded (returns stub provider when S3 isn't configured).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/openapi.json:
    get:
      tags:
        - Auth
      summary: Download the OpenAPI schema
      responses:
        "200":
          description: OpenAPI 3.1 definition for Devlogia's public API.
          content:
            application/json:
              schema: {}
webhooks: {}
